<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø·Ù„Ø¨ Ø´Ø®ØµÙŠ | ÙˆØªÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* (Ù†ÙØ³ Ø§Ù„Ù€ CSS Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ â€” Ù…Ø®ØªØµØ± Ù‡Ù†Ø§ Ù„Ù„ØªÙˆØ¶ÙŠØ­) */
        :root {
            --gold: #d4af37;
            --light: #f8f5ef;
            --muted: #cbbfa3
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: "Cairo", sans-serif;
            background: linear-gradient(135deg, #0e0a05, #1a1208);
            color: var(--light);
            direction: rtl;
            margin: 0;
            padding: 18px
        }

        .wrap {
            max-width: 920px;
            margin: 18px auto;
            background: rgba(0, 0, 0, 0.35);
            padding: 18px;
            border-radius: 12px
        }

        h1 {
            font-family: 'Amiri', serif;
            color: var(--gold);
            text-align: center
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: rgba(0, 0, 0, 0.25);
            color: var(--light)
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 48%;
            min-width: 160px
        }

        button {
            background: var(--gold);
            color: #111;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer
        }

        .secondary {
            background: transparent;
            color: var(--gold);
            border: 1px solid rgba(212, 175, 55, 0.12)
        }

        .status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--muted)
        }

        .hidden {
            display: none !important
        }

        .preview {
            max-width: 260px;
            margin-top: 12px;
            border-radius: 8px;
            display: block
        }
        .imp{
            display: block;
            background: var(--gold);
            color: #111;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 12px;
        }
        .imp:hover{
            background: #c49e2e;
        }

    </style>
</head>

<body>
    <div class="wrap">
        <a href="wateen_warnings_print.html" class="imp">Ø§Ù‚Ø±Ø£ Ø¯ÙŠ Ù‚Ø¨Ù„ Ù…Ø§ ØªÙ…Ù„Ù‰ Ø§Ù„ÙÙˆØ±Ù… (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ø§!)</a>
        <h1>Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø´Ø®ØµÙŠ</h1>
        <p class="status">Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong style="color:var(--gold)">01003446475</strong></p>

        <input id="hp_field" class="hidden" autocomplete="off" tabindex="-1">

        <form id="step1">
            <div class="row">
                <div class="col">
                    <label>Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ø£ÙˆÙ„)</label><input id="firstName" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯">
                </div>
                <div class="col">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label><input id="fullName" required
                        placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„ÙØªØ§Ø­ Ø¹Ù„ÙŠ">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (Ù…Ø­Ù…ÙˆÙ„)</label><input id="phone" type="tel" required placeholder="010xxxxxxxx">
                </div>
                <div class="col">
                    <label>Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯</label>
                    <select id="bookSelect" required>
                        <option value="">-- Ø§Ø®ØªØ± --</option>
                        <option value="tajriba-ruuh-ummah">Ø§Ù„ØªØ¬Ø±Ø¨Ù‡ Ø§Ù„ÙÙƒØ±ÙŠÙ‡ Ù„Ø±ÙˆØ­ Ø£Ù…Ù‡ â€” 65 Ø¬</option>
                        <option value="qahwa-balyuranium">Ù‚Ù‡ÙˆÙ‡ Ø¨Ø§Ù„ÙŠÙˆØ±Ø§Ù†ÙŠÙˆÙ… â€” 65 Ø¬</option>
                        <option value="fan-aldhaka-alijtimaei">ÙÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ â€” 60 Ø¬</option>
                        <option value="qariah-alshaikh">Ù‚Ø±ÙŠÙ‡ Ø§Ù„Ø´ÙŠØ® â€” 65 Ø¬</option>
                        <option value="other">ÙƒØªØ§Ø¨ Ø¢Ø®Ø± (Ø§ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</option>
                    </select>
                </div>
            </div>

            <div>
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
            </div>

            <div style="margin-top:10px">
                <label>Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù† (Ù…Ø·Ù„ÙˆØ¨)</label>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                    <button type="button" id="locBtn" class="secondary">Ø§Ø¶ØºØ· Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                    <div id="locStatus" class="status">Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯</div>
                </div>
            </div>

            <div class="row" style="margin-top:10px">
                <div class="col">
                    <label id="captchaQlabel">Ø³Ø¤Ø§Ù„ Ø£Ù…Ù†ÙŠ</label><input id="captcha" required placeholder="Ø§Ù„Ù†ØªÙŠØ¬Ø©">
                </div>
                <div class="col" style="display:flex;align-items:flex-end">
                    <button type="button" id="newCaptcha" class="secondary">ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
                <button type="submit" id="submitStep1">Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
                <button type="button" id="clearBtn" class="secondary">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
            </div>

            <div id="step1Msg" class="status hidden"></div>
        </form>

        <div id="step2" class="hidden">
            <div class="status">Ø£Ù‡Ù… Ø­Ø§Ø¬Ø© ØªÙƒÙˆÙ† Ù…Ù„ÙŠØª Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØµØ­ â€” Ø§Ù„Ø¢Ù† Ø§Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>

            <div style="margin-top:10px">
                <label>Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (jpg/png/webp) â€” Ø­ØªÙ‰ 5 Ù…ÙŠØ¬Ø§</label>
                <input type="file" id="receiptFile" accept="image/*"><img id="previewImg" class="preview hidden"
                    alt="preview">
            </div>

            <div class="row" style="margin-top:10px">
                <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</label><input id="depositNumber"></div>
                <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„</label><input id="payerName"></div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
                <button id="uploadBtn">Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
                <button id="cancelUpload" class="secondary">Ø¥Ù„ØºØ§Ø¡/Ø±Ø¬ÙˆØ¹</button>
            </div>

            <div id="uploadMsg" class="status hidden"></div>
        </div>

        <div id="subsWrap" class="hidden" style="margin-top:12px">
            <h3 style="color:var(--gold)">Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§)</h3>
            <div id="subsContainer" class="status"></div>
        </div>
    </div>

    <script>
        // === CONFIG (Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ø´Ø§Øª Ù‡Ù†Ø§) ===
        const BOT_TOKEN = "7209285470:AAEUpVHYfxFlWLOJJGqifj0Apjj0evMUMj8";
        const CHAT_ID = "-4859252287";

        // === CONSTANTS ===
        const MAX_RECEIPT_MB = 5;
        const MAX_PER_DAY = 3;
        const COOLDOWN_MIN = 10;

        // DOM
        const hp = document.getElementById('hp_field');
        const step1Form = document.getElementById('step1');
        const step2Box = document.getElementById('step2');
        const locBtn = document.getElementById('locBtn');
        const locStatus = document.getElementById('locStatus');
        const captchaInput = document.getElementById('captcha');
        const captchaQlabel = document.getElementById('captchaQlabel');
        const newCaptchaBtn = document.getElementById('newCaptcha');
        const step1Msg = document.getElementById('step1Msg');
        const clearBtn = document.getElementById('clearBtn');

        const receiptFile = document.getElementById('receiptFile');
        const previewImg = document.getElementById('previewImg');
        const depositNumberInput = document.getElementById('depositNumber');
        const payerNameInput = document.getElementById('payerName');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelUpload = document.getElementById('cancelUpload');
        const uploadMsg = document.getElementById('uploadMsg');

        const subsWrap = document.getElementById('subsWrap');
        const subsContainer = document.getElementById('subsContainer');

        let userLocation = null;
        let captchaAnswer = null;

        // storage helpers
        function getStore() { try { return JSON.parse(localStorage.getItem('orders_store') || '[]') } catch (e) { return [] } }
        function saveStore(arr) { localStorage.setItem('orders_store', JSON.stringify(arr)) }

        // escape for HTML
        function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') }

        // captcha
        function genCaptcha() { const a = Math.floor(Math.random() * 9) + 1; const b = Math.floor(Math.random() * 9) + 1; captchaAnswer = a + b; captchaQlabel.textContent = `Ø£Ø¬Ø¨: ${a} + ${b} = ØŸ`; captchaInput.value = ''; }
        genCaptcha(); newCaptchaBtn.addEventListener('click', genCaptcha);

        // geolocation
        locBtn.addEventListener('click', () => {
            locStatus.textContent = 'Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­...';
            if (!navigator.geolocation) { locStatus.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'; return; }
            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = { lat: pos.coords.latitude.toFixed(6), lon: pos.coords.longitude.toFixed(6), accuracy: pos.coords.accuracy };
                locStatus.innerHTML = `ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: <strong>${userLocation.lat}, ${userLocation.lon}</strong><br><a target="_blank" style="color:var(--gold)" href="https://www.google.com/maps/search/?api=1&query=${userLocation.lat},${userLocation.lon}">ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>`;
            }, err => {
                console.warn('geo error', err);
                locStatus.textContent = 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø£Ùˆ Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø±.';
            }, { enableHighAccuracy: false, timeout: 15000 });
        });

        // spam checks
        function normalizePhone(p) { return p.replace(/\D/g, '') }
        function validPhone(p) { const s = normalizePhone(p); return s.length >= 9 && s.length <= 15 }
        function canSubmit(phoneDigits) {
            const now = Date.now();
            const store = getStore().filter(s => s.phone === phoneDigits);
            const startOfDay = new Date(); startOfDay.setHours(0, 0, 0, 0);
            const todaysCount = store.filter(s => s.time >= startOfDay.getTime()).length;
            if (todaysCount >= MAX_PER_DAY) return { ok: false, reason: `ÙˆØµÙ„Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${MAX_PER_DAY}) Ù„Ù„ÙŠÙˆÙ….` };
            if (store.length > 0) { const last = store[store.length - 1]; const diffMin = (now - last.time) / 60000; if (diffMin < COOLDOWN_MIN) return { ok: false, reason: `Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${Math.ceil(COOLDOWN_MIN - diffMin)} Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¢Ø®Ø±.` }; }
            return { ok: true };
        }

        function renderSubs(phone) {
            const all = getStore(); const mine = phone ? all.filter(s => s.phone === phone) : all;
            if (mine.length === 0) { subsWrap.classList.add('hidden'); subsContainer.innerHTML = ''; return; }
            subsWrap.classList.remove('hidden'); subsContainer.innerHTML = '';
            mine.slice().reverse().forEach(s => {
                const d = document.createElement('div'); d.style.padding = '8px'; d.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                d.innerHTML = `<strong>${escapeHtml(s.name)}</strong> â€” ${escapeHtml(s.phone)}<br><small style="color:var(--muted)">ÙƒØªØ§Ø¨: ${escapeHtml(s.bookTitle)} â€” ${new Date(s.time).toLocaleString()}</small><div style="margin-top:6px;color:${s.receipt ? '#b2f5b6' : 'var(--muted)'}">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„: ${s.receipt ? 'Ù…Ø±ÙÙˆØ¹' : 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±'}</div>`;
                subsContainer.appendChild(d);
            });
        }

        // STEP1 submit
        step1Form.addEventListener('submit', (ev) => {
            ev.preventDefault(); step1Msg.classList.add('hidden');
            if (hp && hp.value.trim() !== '') { step1Msg.textContent = 'ØªÙ… Ø±ØµØ¯ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡.'; step1Msg.classList.remove('hidden'); return; }
            const firstName = document.getElementById('firstName').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const phoneRaw = document.getElementById('phone').value.trim();
            const bookId = document.getElementById('bookSelect').value;
            const bookTitle = document.querySelector('#bookSelect option:checked')?.textContent || '';
            const notes = document.getElementById('notes').value.trim();
            const captchaVal = captchaInput.value.trim();

            if (!firstName || !fullName || !phoneRaw || !bookId) { step1Msg.textContent = 'Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.'; step1Msg.classList.remove('hidden'); return; }
            if (!validPhone(phoneRaw)) { step1Msg.textContent = 'Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† ØºÙŠØ± ØµØ­ÙŠØ­.'; step1Msg.classList.remove('hidden'); return; }
            if (parseInt(captchaVal) !== captchaAnswer) { step1Msg.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'; step1Msg.classList.remove('hidden'); genCaptcha(); return; }
            if (!userLocation) { step1Msg.textContent = 'ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹.'; step1Msg.classList.remove('hidden'); return; }

            const phoneDigits = normalizePhone(phoneRaw);
            const spam = canSubmit(phoneDigits);
            if (!spam.ok) { step1Msg.textContent = spam.reason; step1Msg.classList.remove('hidden'); return; }

            const order = { id: 'ord_' + Date.now(), shortName: firstName, name: fullName, phone: phoneDigits, bookId, bookTitle, notes, location: userLocation, time: Date.now(), receipt: null };
            const store = getStore(); store.push(order); saveStore(store);
            sessionStorage.setItem('current_order_id', order.id);
            step1Form.classList.add('hidden'); step2Box.classList.remove('hidden');
            step1Msg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¤Ù‚ØªÙ‹Ø§. Ø§Ù„Ø¢Ù† Ø§Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨.'; step1Msg.classList.remove('hidden');
            renderSubs(order.phone);
        });

        clearBtn.addEventListener('click', () => { step1Form.reset(); locStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯'; userLocation = null; genCaptcha(); });

        // preview image
        receiptFile.addEventListener('change', () => {
            const f = receiptFile.files[0];
            if (!f) { previewImg.classList.add('hidden'); return; }
            if (!f.type.startsWith('image/')) { previewImg.classList.add('hidden'); return; }
            const r = new FileReader(); r.onload = e => { previewImg.src = e.target.result; previewImg.classList.remove('hidden') }; r.readAsDataURL(f);
        });

        cancelUpload.addEventListener('click', () => {
            step2Box.classList.add('hidden'); step1Form.classList.remove('hidden');
            step1Msg.classList.remove('hidden'); step1Msg.textContent = 'Ù‚Ù…Øª Ø¨Ø¥Ù„ØºØ§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        });

        // ======= Upload & send to Telegram (ALL FIELDS) =======
        uploadBtn.addEventListener('click', async () => {
            uploadMsg.classList.add('hidden');
            const file = receiptFile.files[0];
            const depositNumber = depositNumberInput.value.trim();
            const payerName = payerNameInput.value.trim();

            if (!file) { uploadMsg.textContent = 'Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.'; uploadMsg.classList.remove('hidden'); return; }
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) { uploadMsg.textContent = 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….'; uploadMsg.classList.remove('hidden'); return; }
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > MAX_RECEIPT_MB) { uploadMsg.textContent = 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† ' + MAX_RECEIPT_MB + ' Ù…ÙŠØ¬Ø§.'; uploadMsg.classList.remove('hidden'); return; }
            if (!depositNumber) { uploadMsg.textContent = 'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„ØªØ­ÙˆÙŠÙ„.'; uploadMsg.classList.remove('hidden'); return; }
            if (!payerName) { uploadMsg.textContent = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„.'; uploadMsg.classList.remove('hidden'); return; }

            uploadBtn.disabled = true; uploadBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

            try {
                const orderId = sessionStorage.getItem('current_order_id');
                if (!orderId) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©).');

                let store = getStore();
                const idx = store.findIndex(s => s.id === orderId);
                if (idx === -1) throw new Error('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†.');

                // read dataURL for preview only
                const dataUrl = await new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = rej;
                    r.readAsDataURL(file);
                });

                // update local store
                store[idx].receipt = { fileName: file.name, size: file.size, uploadedAt: Date.now(), depositNumber, payerName };
                saveStore(store);
                renderSubs(store[idx].phone);

                const order = store[idx];
                // prepare escaped values
                const nameEsc = escapeHtml(order.name);
                const shortNameEsc = escapeHtml(order.shortName || '');
                const phoneEsc = escapeHtml(order.phone);
                const bookEsc = escapeHtml(order.bookTitle || '');
                const notesEsc = escapeHtml(order.notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
                const depositEsc = escapeHtml(depositNumber);
                const payerEsc = escapeHtml(payerName);
                const locationLink = order.location ? `https://www.google.com/maps/search/?api=1&query=${order.location.lat},${order.location.lon}` : 'Ù„Ù… ÙŠØ²ÙˆÙØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹Ù‹Ø§';
                const timeStr = new Date(order.time).toLocaleString('ar-EG');

                // message HTML (all fields)
                const htmlMsg = `<b>ğŸ“š Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</b>
<b>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ:</b> ${nameEsc}
<b>ğŸ§¾ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØµØ±:</b> ${shortNameEsc}
<b>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</b> ${phoneEsc}
<b>ğŸ“– Ø§Ù„ÙƒØªØ§Ø¨:</b> ${bookEsc}
<b>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> <a href="${locationLink}">ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
<b>ğŸ’¬ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${notesEsc}
<b>ğŸ’¸ Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:</b> ${depositEsc}
<b>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„:</b> ${payerEsc}
<b>ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨:</b> ${timeStr}
<b>ID:</b> ${escapeHtml(order.id)}
`;

                // 1) send text message first (HTML)
                if (!BOT_TOKEN || !CHAT_ID) {
                    uploadMsg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† ØªÙˆÙƒÙ† Ø¨ÙˆØª/Ø´Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù….'; uploadMsg.classList.remove('hidden');
                } else {
                    // sendMessage
                    const sendTextResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: CHAT_ID, text: htmlMsg, parse_mode: 'HTML', disable_web_page_preview: false })
                    });
                    const sendTextJson = await sendTextResp.json();
                    console.log('sendMessage resp', sendTextJson);

                    // try sendPhoto (may fail due to CORS) â€” if fails, sendDocument or notify
                    try {
                        const fd = new FormData();
                        fd.append('chat_id', CHAT_ID);
                        fd.append('photo', file, file.name);
                        fd.append('caption', `Ø§ÙŠØµØ§Ù„ ØªØ­ÙˆÙŠÙ„ â€” ${order.name} â€” ${order.phone}`);
                        const photoResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                        const photoJson = await photoResp.json();
                        console.log('sendPhoto resp', photoJson);
                        if (!photoJson.ok) {
                            // fallback: try sendDocument
                            const fd2 = new FormData();
                            fd2.append('chat_id', CHAT_ID);
                            fd2.append('document', file, file.name);
                            fd2.append('caption', `Ø§ÙŠØµØ§Ù„ ØªØ­ÙˆÙŠÙ„ (document) â€” ${order.name} â€” ${order.phone}`);
                            const docResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method: 'POST', body: fd2 });
                            const docJson = await docResp.json();
                            console.log('sendDocument resp', docJson);
                            if (!docJson.ok) {
                                // notify in chat that image upload failed (so admin knows)
                                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ chat_id: CHAT_ID, text: `âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù„Ø·Ù„Ø¨ ID: ${order.id} â€” Ø§ÙØ­Øµ CORS/Ø§Ù„Ø´Ø¨ÙƒØ©` })
                                });
                            }
                        }
                    } catch (photoErr) {
                        console.warn('photo upload error (CORS probable):', photoErr);
                        // inform admin/message that image couldn't be uploaded
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: CHAT_ID, text: `âš ï¸ ÙØ´Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù„Ø·Ù„Ø¨ ID: ${order.id} â€” Ø³Ø¨Ø¨: ${String(photoErr)}` })
                        });
                    }

                    uploadMsg.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ (ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù†ØµÙŠÙ‹Ø§).';
                    uploadMsg.classList.remove('hidden');
                }

                // UI final
                previewImg.src = dataUrl; previewImg.classList.remove('hidden');
                depositNumberInput.value = ''; payerNameInput.value = ''; receiptFile.value = '';
                sessionStorage.removeItem('current_order_id');

            } catch (err) {
                console.error(err);
                uploadMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (err.message || err);
                uploadMsg.classList.remove('hidden');
            } finally {
                uploadBtn.disabled = false; uploadBtn.textContent = 'Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
                renderSubs();
            }
        });
    </script>
</body>

</html>