<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>طلب شخصي | وتين</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* (نفس الـ CSS اللي عندك — مختصر هنا للتوضيح) */
        :root {
            --gold: #d4af37;
            --light: #f8f5ef;
            --muted: #cbbfa3
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: "Cairo", sans-serif;
            background: linear-gradient(135deg, #0e0a05, #1a1208);
            color: var(--light);
            direction: rtl;
            margin: 0;
            padding: 18px
        }

        .wrap {
            max-width: 920px;
            margin: 18px auto;
            background: rgba(0, 0, 0, 0.35);
            padding: 18px;
            border-radius: 12px
        }

        h1 {
            font-family: 'Amiri', serif;
            color: var(--gold);
            text-align: center
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: rgba(0, 0, 0, 0.25);
            color: var(--light)
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 48%;
            min-width: 160px
        }

        button {
            background: var(--gold);
            color: #111;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer
        }

        .secondary {
            background: transparent;
            color: var(--gold);
            border: 1px solid rgba(212, 175, 55, 0.12)
        }

        .status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--muted)
        }

        .hidden {
            display: none !important
        }

        .preview {
            max-width: 260px;
            margin-top: 12px;
            border-radius: 8px;
            display: block
        }
        .imp{
            display: block;
            background: var(--gold);
            color: #111;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 12px;
        }
        .imp:hover{
            background: #c49e2e;
        }

    </style>
</head>

<body>
    <div class="wrap">
        <a href="wateen_warnings_print.html" class="imp">اقرأ دي قبل ما تملى الفورم (مهم جداا!)</a>
        <h1>نموذج طلب شخصي</h1>
        <p class="status">رقم التحويل الظاهر للمستخدم: <strong style="color:var(--gold)">01003446475</strong></p>

        <input id="hp_field" class="hidden" autocomplete="off" tabindex="-1">

        <form id="step1">
            <div class="row">
                <div class="col">
                    <label>الاسم (الأول)</label><input id="firstName" required placeholder="مثال: محمد">
                </div>
                <div class="col">
                    <label>الاسم الرباعي</label><input id="fullName" required
                        placeholder="مثال: محمد أحمد عبد الفتاح علي">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>رقم التليفون (محمول)</label><input id="phone" type="tel" required placeholder="010xxxxxxxx">
                </div>
                <div class="col">
                    <label>الكتاب الذي تريد</label>
                    <select id="bookSelect" required>
                        <option value="">-- اختر --</option>
                        <option value="tajriba-ruuh-ummah">التجربه الفكريه لروح أمه — 65 ج</option>
                        <option value="qahwa-balyuranium">قهوه باليورانيوم — 65 ج</option>
                        <option value="fan-aldhaka-alijtimaei">فن الذكاء الاجتماعي — 60 ج</option>
                        <option value="qariah-alshaikh">قريه الشيخ — 65 ج</option>
                        <option value="other">كتاب آخر (اكتب في الملاحظات)</option>
                    </select>
                </div>
            </div>

            <div>
                <label>ملاحظات</label><textarea id="notes" placeholder="ملاحظات"></textarea>
            </div>

            <div style="margin-top:10px">
                <label>موقعك الآن (مطلوب)</label>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                    <button type="button" id="locBtn" class="secondary">اضغط لجلب الموقع</button>
                    <div id="locStatus" class="status">لم يتم جلب الموقع بعد</div>
                </div>
            </div>

            <div class="row" style="margin-top:10px">
                <div class="col">
                    <label id="captchaQlabel">سؤال أمني</label><input id="captcha" required placeholder="النتيجة">
                </div>
                <div class="col" style="display:flex;align-items:flex-end">
                    <button type="button" id="newCaptcha" class="secondary">تغيير السؤال</button>
                </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
                <button type="submit" id="submitStep1">حفظ ومتابعة</button>
                <button type="button" id="clearBtn" class="secondary">تفريغ الحقول</button>
            </div>

            <div id="step1Msg" class="status hidden"></div>
        </form>

        <div id="step2" class="hidden">
            <div class="status">أهم حاجة تكون مليت بياناتك صح — الآن ارفع إيصال التحويل</div>

            <div style="margin-top:10px">
                <label>رفع صورة إيصال التحويل (jpg/png/webp) — حتى 5 ميجا</label>
                <input type="file" id="receiptFile" accept="image/*"><img id="previewImg" class="preview hidden"
                    alt="preview">
            </div>

            <div class="row" style="margin-top:10px">
                <div class="col"><label>رقم الإيداع</label><input id="depositNumber"></div>
                <div class="col"><label>اسم المحول</label><input id="payerName"></div>
            </div>

            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
                <button id="uploadBtn">رفع الإيصال وتأكيد الطلب</button>
                <button id="cancelUpload" class="secondary">إلغاء/رجوع</button>
            </div>

            <div id="uploadMsg" class="status hidden"></div>
        </div>

        <div id="subsWrap" class="hidden" style="margin-top:12px">
            <h3 style="color:var(--gold)">طلباتك السابقة (محليًا)</h3>
            <div id="subsContainer" class="status"></div>
        </div>
    </div>

    <script>
        // === CONFIG (ضع التوكن والشات هنا) ===
        const BOT_TOKEN = "7209285470:AAEUpVHYfxFlWLOJJGqifj0Apjj0evMUMj8";
        const CHAT_ID = "-4859252287";

        // === CONSTANTS ===
        const MAX_RECEIPT_MB = 5;
        const MAX_PER_DAY = 3;
        const COOLDOWN_MIN = 10;

        // DOM
        const hp = document.getElementById('hp_field');
        const step1Form = document.getElementById('step1');
        const step2Box = document.getElementById('step2');
        const locBtn = document.getElementById('locBtn');
        const locStatus = document.getElementById('locStatus');
        const captchaInput = document.getElementById('captcha');
        const captchaQlabel = document.getElementById('captchaQlabel');
        const newCaptchaBtn = document.getElementById('newCaptcha');
        const step1Msg = document.getElementById('step1Msg');
        const clearBtn = document.getElementById('clearBtn');

        const receiptFile = document.getElementById('receiptFile');
        const previewImg = document.getElementById('previewImg');
        const depositNumberInput = document.getElementById('depositNumber');
        const payerNameInput = document.getElementById('payerName');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelUpload = document.getElementById('cancelUpload');
        const uploadMsg = document.getElementById('uploadMsg');

        const subsWrap = document.getElementById('subsWrap');
        const subsContainer = document.getElementById('subsContainer');

        let userLocation = null;
        let captchaAnswer = null;

        // storage helpers
        function getStore() { try { return JSON.parse(localStorage.getItem('orders_store') || '[]') } catch (e) { return [] } }
        function saveStore(arr) { localStorage.setItem('orders_store', JSON.stringify(arr)) }

        // escape for HTML
        function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') }

        // captcha
        function genCaptcha() { const a = Math.floor(Math.random() * 9) + 1; const b = Math.floor(Math.random() * 9) + 1; captchaAnswer = a + b; captchaQlabel.textContent = `أجب: ${a} + ${b} = ؟`; captchaInput.value = ''; }
        genCaptcha(); newCaptchaBtn.addEventListener('click', genCaptcha);

        // geolocation
        locBtn.addEventListener('click', () => {
            locStatus.textContent = 'جارِ جلب الموقع — اسمح للمتصفح...';
            if (!navigator.geolocation) { locStatus.textContent = 'المتصفح لا يدعم تحديد الموقع.'; return; }
            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = { lat: pos.coords.latitude.toFixed(6), lon: pos.coords.longitude.toFixed(6), accuracy: pos.coords.accuracy };
                locStatus.innerHTML = `تم الحصول على الموقع: <strong>${userLocation.lat}, ${userLocation.lon}</strong><br><a target="_blank" style="color:var(--gold)" href="https://www.google.com/maps/search/?api=1&query=${userLocation.lat},${userLocation.lon}">فتح على الخريطة</a>`;
            }, err => {
                console.warn('geo error', err);
                locStatus.textContent = 'فشل جلب الموقع — تأكد من الأذونات أو جرب متصفح آخر.';
            }, { enableHighAccuracy: false, timeout: 15000 });
        });

        // spam checks
        function normalizePhone(p) { return p.replace(/\D/g, '') }
        function validPhone(p) { const s = normalizePhone(p); return s.length >= 9 && s.length <= 15 }
        function canSubmit(phoneDigits) {
            const now = Date.now();
            const store = getStore().filter(s => s.phone === phoneDigits);
            const startOfDay = new Date(); startOfDay.setHours(0, 0, 0, 0);
            const todaysCount = store.filter(s => s.time >= startOfDay.getTime()).length;
            if (todaysCount >= MAX_PER_DAY) return { ok: false, reason: `وصلت الحد الأقصى (${MAX_PER_DAY}) لليوم.` };
            if (store.length > 0) { const last = store[store.length - 1]; const diffMin = (now - last.time) / 60000; if (diffMin < COOLDOWN_MIN) return { ok: false, reason: `الرجاء الانتظار ${Math.ceil(COOLDOWN_MIN - diffMin)} دقيقة قبل إرسال طلب آخر.` }; }
            return { ok: true };
        }

        function renderSubs(phone) {
            const all = getStore(); const mine = phone ? all.filter(s => s.phone === phone) : all;
            if (mine.length === 0) { subsWrap.classList.add('hidden'); subsContainer.innerHTML = ''; return; }
            subsWrap.classList.remove('hidden'); subsContainer.innerHTML = '';
            mine.slice().reverse().forEach(s => {
                const d = document.createElement('div'); d.style.padding = '8px'; d.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                d.innerHTML = `<strong>${escapeHtml(s.name)}</strong> — ${escapeHtml(s.phone)}<br><small style="color:var(--muted)">كتاب: ${escapeHtml(s.bookTitle)} — ${new Date(s.time).toLocaleString()}</small><div style="margin-top:6px;color:${s.receipt ? '#b2f5b6' : 'var(--muted)'}">حالة الإيصال: ${s.receipt ? 'مرفوع' : 'في انتظار'}</div>`;
                subsContainer.appendChild(d);
            });
        }

        // STEP1 submit
        step1Form.addEventListener('submit', (ev) => {
            ev.preventDefault(); step1Msg.classList.add('hidden');
            if (hp && hp.value.trim() !== '') { step1Msg.textContent = 'تم رصد نشاط مشبوه.'; step1Msg.classList.remove('hidden'); return; }
            const firstName = document.getElementById('firstName').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const phoneRaw = document.getElementById('phone').value.trim();
            const bookId = document.getElementById('bookSelect').value;
            const bookTitle = document.querySelector('#bookSelect option:checked')?.textContent || '';
            const notes = document.getElementById('notes').value.trim();
            const captchaVal = captchaInput.value.trim();

            if (!firstName || !fullName || !phoneRaw || !bookId) { step1Msg.textContent = 'اكمل جميع الحقول المطلوبة.'; step1Msg.classList.remove('hidden'); return; }
            if (!validPhone(phoneRaw)) { step1Msg.textContent = 'رقم التليفون غير صحيح.'; step1Msg.classList.remove('hidden'); return; }
            if (parseInt(captchaVal) !== captchaAnswer) { step1Msg.textContent = 'إجابة السؤال الأمني غير صحيحة.'; step1Msg.classList.remove('hidden'); genCaptcha(); return; }
            if (!userLocation) { step1Msg.textContent = 'يجب جلب الموقع أولاً.'; step1Msg.classList.remove('hidden'); return; }

            const phoneDigits = normalizePhone(phoneRaw);
            const spam = canSubmit(phoneDigits);
            if (!spam.ok) { step1Msg.textContent = spam.reason; step1Msg.classList.remove('hidden'); return; }

            const order = { id: 'ord_' + Date.now(), shortName: firstName, name: fullName, phone: phoneDigits, bookId, bookTitle, notes, location: userLocation, time: Date.now(), receipt: null };
            const store = getStore(); store.push(order); saveStore(store);
            sessionStorage.setItem('current_order_id', order.id);
            step1Form.classList.add('hidden'); step2Box.classList.remove('hidden');
            step1Msg.textContent = 'تم حفظ بياناتك مؤقتًا. الآن ارفع إيصال التحويل لتأكيد الطلب.'; step1Msg.classList.remove('hidden');
            renderSubs(order.phone);
        });

        clearBtn.addEventListener('click', () => { step1Form.reset(); locStatus.textContent = 'لم يتم جلب الموقع بعد'; userLocation = null; genCaptcha(); });

        // preview image
        receiptFile.addEventListener('change', () => {
            const f = receiptFile.files[0];
            if (!f) { previewImg.classList.add('hidden'); return; }
            if (!f.type.startsWith('image/')) { previewImg.classList.add('hidden'); return; }
            const r = new FileReader(); r.onload = e => { previewImg.src = e.target.result; previewImg.classList.remove('hidden') }; r.readAsDataURL(f);
        });

        cancelUpload.addEventListener('click', () => {
            step2Box.classList.add('hidden'); step1Form.classList.remove('hidden');
            step1Msg.classList.remove('hidden'); step1Msg.textContent = 'قمت بإلغاء رفع الإيصال — يمكنك تعديل بياناتك أو المحاولة مرة أخرى.';
        });

        // ======= Upload & send to Telegram (ALL FIELDS) =======
        uploadBtn.addEventListener('click', async () => {
            uploadMsg.classList.add('hidden');
            const file = receiptFile.files[0];
            const depositNumber = depositNumberInput.value.trim();
            const payerName = payerNameInput.value.trim();

            if (!file) { uploadMsg.textContent = 'اختر صورة الإيصال أولاً.'; uploadMsg.classList.remove('hidden'); return; }
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) { uploadMsg.textContent = 'نوع الملف غير مدعوم.'; uploadMsg.classList.remove('hidden'); return; }
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > MAX_RECEIPT_MB) { uploadMsg.textContent = 'حجم الملف أكبر من ' + MAX_RECEIPT_MB + ' ميجا.'; uploadMsg.classList.remove('hidden'); return; }
            if (!depositNumber) { uploadMsg.textContent = 'اكتب رقم الإيداع/التحويل.'; uploadMsg.classList.remove('hidden'); return; }
            if (!payerName) { uploadMsg.textContent = 'اكتب اسم المحول.'; uploadMsg.classList.remove('hidden'); return; }

            uploadBtn.disabled = true; uploadBtn.textContent = 'جاري الرفع...';

            try {
                const orderId = sessionStorage.getItem('current_order_id');
                if (!orderId) throw new Error('لم يتم العثور على الطلب (انتهت الجلسة).');

                let store = getStore();
                const idx = store.findIndex(s => s.id === orderId);
                if (idx === -1) throw new Error('الطلب غير موجود في التخزين.');

                // read dataURL for preview only
                const dataUrl = await new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = rej;
                    r.readAsDataURL(file);
                });

                // update local store
                store[idx].receipt = { fileName: file.name, size: file.size, uploadedAt: Date.now(), depositNumber, payerName };
                saveStore(store);
                renderSubs(store[idx].phone);

                const order = store[idx];
                // prepare escaped values
                const nameEsc = escapeHtml(order.name);
                const shortNameEsc = escapeHtml(order.shortName || '');
                const phoneEsc = escapeHtml(order.phone);
                const bookEsc = escapeHtml(order.bookTitle || '');
                const notesEsc = escapeHtml(order.notes || 'لا يوجد');
                const depositEsc = escapeHtml(depositNumber);
                const payerEsc = escapeHtml(payerName);
                const locationLink = order.location ? `https://www.google.com/maps/search/?api=1&query=${order.location.lat},${order.location.lon}` : 'لم يزوِد المستخدم موقعًا';
                const timeStr = new Date(order.time).toLocaleString('ar-EG');

                // message HTML (all fields)
                const htmlMsg = `<b>📚 طلب شراء جديد</b>
<b>👤 الاسم الرباعي:</b> ${nameEsc}
<b>🧾 الاسم المختصر:</b> ${shortNameEsc}
<b>📞 الهاتف:</b> ${phoneEsc}
<b>📖 الكتاب:</b> ${bookEsc}
<b>📍 الموقع:</b> <a href="${locationLink}">فتح على الخريطة</a>
<b>💬 الملاحظات:</b> ${notesEsc}
<b>💸 رقم الإيداع:</b> ${depositEsc}
<b>👤 اسم المحول:</b> ${payerEsc}
<b>🕒 وقت الطلب:</b> ${timeStr}
<b>ID:</b> ${escapeHtml(order.id)}
`;

                // 1) send text message first (HTML)
                if (!BOT_TOKEN || !CHAT_ID) {
                    uploadMsg.textContent = 'تم حفظ الطلب محليًا، لكن لم يتم تكوين توكن بوت/شات تليجرام.'; uploadMsg.classList.remove('hidden');
                } else {
                    // sendMessage
                    const sendTextResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: CHAT_ID, text: htmlMsg, parse_mode: 'HTML', disable_web_page_preview: false })
                    });
                    const sendTextJson = await sendTextResp.json();
                    console.log('sendMessage resp', sendTextJson);

                    // try sendPhoto (may fail due to CORS) — if fails, sendDocument or notify
                    try {
                        const fd = new FormData();
                        fd.append('chat_id', CHAT_ID);
                        fd.append('photo', file, file.name);
                        fd.append('caption', `ايصال تحويل — ${order.name} — ${order.phone}`);
                        const photoResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                        const photoJson = await photoResp.json();
                        console.log('sendPhoto resp', photoJson);
                        if (!photoJson.ok) {
                            // fallback: try sendDocument
                            const fd2 = new FormData();
                            fd2.append('chat_id', CHAT_ID);
                            fd2.append('document', file, file.name);
                            fd2.append('caption', `ايصال تحويل (document) — ${order.name} — ${order.phone}`);
                            const docResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method: 'POST', body: fd2 });
                            const docJson = await docResp.json();
                            console.log('sendDocument resp', docJson);
                            if (!docJson.ok) {
                                // notify in chat that image upload failed (so admin knows)
                                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ chat_id: CHAT_ID, text: `⚠️ فشل رفع صورة الإيصال لطلب ID: ${order.id} — افحص CORS/الشبكة` })
                                });
                            }
                        }
                    } catch (photoErr) {
                        console.warn('photo upload error (CORS probable):', photoErr);
                        // inform admin/message that image couldn't be uploaded
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: CHAT_ID, text: `⚠️ فشل رفع صورة الإيصال لطلب ID: ${order.id} — سبب: ${String(photoErr)}` })
                        });
                    }

                    uploadMsg.textContent = '✅ تم إرسال الطلب بنجاح (تم إرسال كل الحقول نصيًا).';
                    uploadMsg.classList.remove('hidden');
                }

                // UI final
                previewImg.src = dataUrl; previewImg.classList.remove('hidden');
                depositNumberInput.value = ''; payerNameInput.value = ''; receiptFile.value = '';
                sessionStorage.removeItem('current_order_id');

            } catch (err) {
                console.error(err);
                uploadMsg.textContent = 'حدث خطأ أثناء الإرسال: ' + (err.message || err);
                uploadMsg.classList.remove('hidden');
            } finally {
                uploadBtn.disabled = false; uploadBtn.textContent = 'رفع الإيصال وتأكيد الطلب';
                renderSubs();
            }
        });
    </script>
</body>

</html>