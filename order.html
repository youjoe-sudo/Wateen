<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø·Ù„Ø¨ Ø´Ø®ØµÙŠ | ÙˆØªÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --dark: #0e0a05;
            --card: rgba(25, 18, 10, 0.88);
            --muted: #cbbfa3;
            --light: #f8f5ef;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0e0a05, #1a1208);
            color: var(--light);
            margin: 0;
            padding: 18px;
            direction: rtl;
        }

        .wrap {
            max-width: 920px;
            margin: 18px auto;
            background: rgba(0, 0, 0, 0.35);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid rgba(212, 175, 55, 0.06);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        h1 {
            font-family: 'Amiri', serif;
            color: var(--gold);
            margin: 4px 0 10px;
            text-align: center;
        }

        label {
            display: block;
            color: var(--muted);
            font-size: 0.95rem;
            margin-top: 10px;
        }

        input[type="text"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: rgba(0, 0, 0, 0.25);
            color: var(--light);
        }

        textarea {
            min-height: 90px;
            resize: vertical;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1 1 48%;
            min-width: 160px;
        }

        .full {
            flex: 1 1 100%;
        }

        button {
            background: var(--gold);
            color: #111;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 12px;
        }

        .secondary {
            background: transparent;
            color: var(--gold);
            border: 1px solid rgba(212, 175, 55, 0.12);
        }

        .hint {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 6px;
        }

        .map-box {
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            color: var(--muted);
            margin-top: 8px;
        }

        .hidden {
            display: none !important;
        }

        .center {
            text-align: center;
        }

        input {
            font-family: 'Cairo', sans-serif;
            outline: none;
            padding: 1.1em 1em;
            transition: border-color 0.3s;
            border: #d4af37 1px solid;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            background-color: #1a1208;
            border-radius: 20px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--gold);
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        }

        button:hover {
            background: #c49e34;
        }

        button:disabled,
        button[disabled] {
            background: rgba(212, 175, 55, 0.4);
            cursor: not-allowed;
        }

        .warning {
            background: rgba(255, 221, 153, 0.06);
            color: #ffdd99;
            padding: 8px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .preview {
            max-width: 260px;
            margin-top: 12px;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
            display: block;
        }

        .status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--muted);
        }

        @media (max-width:520px) {
            .col {
                flex: 1 1 100%
            }

            h1 {
                font-size: 1.4rem
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø´Ø®ØµÙŠ</h1>
        <p class="center hint">Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong style="color:var(--gold)">201017421891</strong></p>

        <!-- honeypot Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¨ÙˆØª -->
        <input id="hp_field" name="hp_field" class="hidden" autocomplete="off" tabindex="-1">

        <!-- STEP 1 -->
        <form id="step1">
            <div class="row">
                <div class="col">
                    <label for="firstName">Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ø£ÙˆÙ„)</label>
                    <input id="firstName" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯">
                </div>
                <div class="col">
                    <label for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
                    <input id="fullName" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„ÙØªØ§Ø­ Ø¹Ù„ÙŠ">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label for="phone">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (Ù…Ø­Ù…ÙˆÙ„)</label>
                    <input id="phone" type="tel" required placeholder="010xxxxxxxx">
                    <div class="hint">Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¯ÙˆÙ† +</div>
                </div>
                <div class="col">
                    <label for="bookSelect">Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯</label>
                    <select id="bookSelect" required>
                        <option value="">-- Ø§Ø®ØªØ± --</option>
                        <option value="tajriba-ruuh-ummah">Ø§Ù„ØªØ¬Ø±Ø¨Ù‡ Ø§Ù„ÙÙƒØ±ÙŠÙ‡ Ù„Ø±ÙˆØ­ Ø£Ù…Ù‡ â€” 65 Ø¬</option>
                        <option value="qahwa-balyuranium">Ù‚Ù‡ÙˆÙ‡ Ø¨Ø§Ù„ÙŠÙˆØ±Ø§Ù†ÙŠÙˆÙ… â€” 65 Ø¬</option>
                        <option value="fan-aldhaka-alijtimaei">ÙÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ â€” 60 Ø¬</option>
                        <option value="qariah-alshaikh">Ù‚Ø±ÙŠÙ‡ Ø§Ù„Ø´ÙŠØ® â€” 65 Ø¬</option>
                        <option value="other">ÙƒØªØ§Ø¨ Ø¢Ø®Ø± (Ø§ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</option>
                    </select>
                </div>
            </div>

            <div class="full">
                <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ø³Ù… Ø§Ù„Ø·Ø¨Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
            </div>

            <div class="full">
                <label>Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¢Ù† (Ù…Ø·Ù„ÙˆØ¨)</label>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button type="button" id="locBtn" class="secondary">Ø§Ø¶ØºØ· Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                    <div id="locStatus" class="map-box">Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯</div>
                </div>
                <div class="hint">Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø¯ÙŠØ© Ø§Ù„Ø·Ù„Ø¨.</div>
            </div>

            <div class="row">
                <div class="col">
                    <label id="captchaQlabel">Ø³Ø¤Ø§Ù„ Ø£Ù…Ù†ÙŠ (Ø§Ø¬Ù…Ø¹ Ø±Ù‚Ù…ÙŠÙ†)</label>
                    <input id="captcha" required placeholder="Ø§Ù„Ù†ØªÙŠØ¬Ø©">
                </div>
                <div class="col center" style="align-self:flex-end;">
                    <button type="button" id="newCaptcha" class="secondary">ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
                <button type="submit" id="submitStep1">Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
                <button type="button" id="clearBtn" class="secondary">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
            </div>

            <div id="step1Msg" class="status hidden"></div>
        </form>

        <!-- STEP 2 -->
        <div id="step2" class="hidden">
            <div class="warning center"><strong>Ø£Ù‡Ù… Ø­Ø§Ø¬Ø© ØªÙƒÙˆÙ† Ù…Ù„ÙŠØª Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ØµØ­</strong><br>Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù‚Ù… Ø¨Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„
                Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>

            <div style="margin-top:12px;">
                <label>Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (jpg/png/webp) â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§</label>
                <input type="file" id="receiptFile" accept="image/*">
                <img id="previewImg" class="preview hidden" alt="preview">
            </div>

            <div class="row">
                <div class="col">
                    <label for="depositNumber">Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ / Ø§Ù„ØªØ­ÙˆÙŠÙ„</label>
                    <input id="depositNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØªØ­ÙˆÙŠÙ„">
                </div>
                <div class="col">
                    <label for="payerName">Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
                    <input id="payerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„">
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
                <button id="uploadBtn">Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
                <button id="cancelUpload" class="secondary">Ø¥Ù„ØºØ§Ø¡/Ø±Ø¬ÙˆØ¹</button>
            </div>

            <div id="uploadMsg" class="status hidden"></div>
        </div>

        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© -->
        <div id="subsWrap" class="hidden" style="margin-top:14px;">
            <h3 style="color:var(--gold); margin-bottom:6px;">Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§)</h3>
            <div id="subsContainer" class="status"></div>
        </div>
    </div>

    <script>
        /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ØºÙŠÙ‘Ø± BOT_TOKEN Ùˆ CHAT_ID) ===== */
        const BOT_TOKEN = "7209285470:AAEUpVHYfxFlWLOJJGqifj0Apjj0evMUMj8";
        const CHAT_ID = "-4859252287";

        /* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø­Ù…Ø§ÙŠØ© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===== */
        const MAX_PER_DAY = 3;
        const COOLDOWN_MIN = 10;
        const MAX_RECEIPT_MB = 5;

        /* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
        const hp = document.getElementById('hp_field');
        const step1Form = document.getElementById('step1');
        const step2Box = document.getElementById('step2');
        const locBtn = document.getElementById('locBtn');
        const locStatus = document.getElementById('locStatus');
        const captchaInput = document.getElementById('captcha');
        const captchaQlabel = document.getElementById('captchaQlabel');
        const newCaptchaBtn = document.getElementById('newCaptcha');
        const step1Msg = document.getElementById('step1Msg');
        const submitStep1 = document.getElementById('submitStep1');
        const clearBtn = document.getElementById('clearBtn');

        const receiptFile = document.getElementById('receiptFile');
        const previewImg = document.getElementById('previewImg');
        const depositNumberInput = document.getElementById('depositNumber');
        const payerNameInput = document.getElementById('payerName');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelUpload = document.getElementById('cancelUpload');
        const uploadMsg = document.getElementById('uploadMsg');

        const subsWrap = document.getElementById('subsWrap');
        const subsContainer = document.getElementById('subsContainer');

        let userLocation = null;
        let captchaAnswer = null;

        /* ===== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† ===== */
        function getStore() { try { return JSON.parse(localStorage.getItem('orders_store') || '[]'); } catch (e) { return []; } }
        function saveStore(arr) { localStorage.setItem('orders_store', JSON.stringify(arr)); }

        /* ===== ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø³ÙŠØ· ===== */
        function genCaptcha() {
            const a = Math.floor(Math.random() * 9) + 1;
            const b = Math.floor(Math.random() * 9) + 1;
            captchaAnswer = a + b;
            captchaQlabel.textContent = `Ø£Ø¬Ø¨: ${a} + ${b} = ØŸ`;
            captchaInput.value = '';
        }
        genCaptcha();
        newCaptchaBtn.addEventListener('click', genCaptcha);

        /* ===== Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¬ØºØ±Ø§ÙÙŠ) ===== */
        locBtn.addEventListener('click', () => {
            locStatus.textContent = 'Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­...';
            if (!navigator.geolocation) { locStatus.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'; return; }
            navigator.geolocation.getCurrentPosition((pos) => {
                userLocation = { lat: pos.coords.latitude.toFixed(6), lon: pos.coords.longitude.toFixed(6), accuracy: pos.coords.accuracy };
                locStatus.innerHTML = `ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: <strong>${userLocation.lat}, ${userLocation.lon}</strong><br><a target="_blank" style="color:var(--gold)" href="https://www.google.com/maps/search/?api=1&query=${userLocation.lat},${userLocation.lon}">ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>`;
            }, (err) => {
                locStatus.textContent = 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.';
            }, { enableHighAccuracy: false, timeout: 10000 });
        });

        /* ===== ØªØ­Ù‚Ù‚ Ø³Ø¨Ø§Ù… (Ø­Ø¯ ÙŠÙˆÙ…ÙŠ ÙˆÙƒÙˆÙ„Ø¯Ø§ÙˆÙ†) ===== */
        function canSubmit(phoneDigits) {
            const now = Date.now();
            const store = getStore().filter(s => s.phone === phoneDigits);
            const startOfDay = new Date(); startOfDay.setHours(0, 0, 0, 0);
            const todaysCount = store.filter(s => s.time >= startOfDay.getTime()).length;
            if (todaysCount >= MAX_PER_DAY) return { ok: false, reason: `ÙˆØµÙ„Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${MAX_PER_DAY}) Ù„Ù„ÙŠÙˆÙ….` };
            if (store.length > 0) {
                const last = store[store.length - 1];
                const diffMin = (now - last.time) / 60000;
                if (diffMin < COOLDOWN_MIN) return { ok: false, reason: `Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${Math.ceil(COOLDOWN_MIN - diffMin)} Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¢Ø®Ø±.` };
            }
            return { ok: true };
        }

        /* ===== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ===== */
        function renderSubs(phone) {
            const all = getStore();
            const mine = phone ? all.filter(s => s.phone === phone) : all;
            if (mine.length === 0) { subsWrap.classList.add('hidden'); subsContainer.innerHTML = ''; return; }
            subsWrap.classList.remove('hidden');
            subsContainer.innerHTML = '';
            mine.slice().reverse().forEach(s => {
                const d = document.createElement('div');
                d.style.padding = '8px'; d.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
                d.innerHTML = `<strong>${s.name}</strong> â€” ${s.phone}<br><small style="color:var(--muted)">ÙƒØªØ§Ø¨: ${s.bookTitle} â€” ${new Date(s.time).toLocaleString()}</small><div style="margin-top:6px;color:${s.receipt ? '#b2f5b6' : 'var(--muted)'}">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„: ${s.receipt ? 'Ù…Ø±ÙÙˆØ¹' : 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±'}</div>`;
                subsContainer.appendChild(d);
            });
        }

        /* ===== validate phone ===== */
        function normalizePhone(p) { return p.replace(/\D/g, ''); }
        function validPhone(p) { const s = normalizePhone(p); return s.length >= 9 && s.length <= 15; }

        /* ===== STEP1 submit ===== */
        step1Form.addEventListener('submit', (ev) => {
            ev.preventDefault();
            step1Msg.classList.add('hidden');

            // honeypot
            if (hp && hp.value.trim() !== '') { step1Msg.textContent = 'ØªÙ… Ø±ØµØ¯ Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡.'; step1Msg.classList.remove('hidden'); return; }

            const firstName = document.getElementById('firstName').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const phoneRaw = document.getElementById('phone').value.trim();
            const bookId = document.getElementById('bookSelect').value;
            const bookTitle = document.querySelector('#bookSelect option:checked')?.textContent || '';
            const notes = document.getElementById('notes').value.trim();
            const captchaVal = captchaInput.value.trim();

            if (!firstName || !fullName || !phoneRaw || !bookId) { step1Msg.textContent = 'Ø§ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.'; step1Msg.classList.remove('hidden'); return; }
            if (!validPhone(phoneRaw)) { step1Msg.textContent = 'Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† ØºÙŠØ± ØµØ­ÙŠØ­.'; step1Msg.classList.remove('hidden'); return; }
            if (parseInt(captchaVal) !== captchaAnswer) { step1Msg.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ù…Ù†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'; step1Msg.classList.remove('hidden'); genCaptcha(); return; }
            if (!userLocation) { step1Msg.textContent = 'ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹.'; step1Msg.classList.remove('hidden'); return; }

            // spam checks
            const phoneDigits = normalizePhone(phoneRaw);
            const spam = canSubmit(phoneDigits);
            if (!spam.ok) { step1Msg.textContent = spam.reason; step1Msg.classList.remove('hidden'); return; }

            // build order
            const order = {
                id: 'ord_' + Date.now(),
                shortName: firstName,
                name: fullName,
                phone: phoneDigits,
                bookId,
                bookTitle,
                notes,
                location: userLocation,
                time: Date.now(),
                receipt: null
            };

            // save to store (local)
            const store = getStore();
            store.push(order);
            saveStore(store);

            // save current id to session for step2
            sessionStorage.setItem('current_order_id', order.id);

            // UI transition
            step1Form.classList.add('hidden');
            step2Box.classList.remove('hidden');
            step1Msg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¤Ù‚ØªÙ‹Ø§. Ø§Ù„Ø¢Ù† Ø§Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨.';
            step1Msg.classList.remove('hidden');

            renderSubs(order.phone);
        });

        /* ===== clear btn ===== */
        clearBtn.addEventListener('click', () => {
            step1Form.reset();
            locStatus.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯';
            userLocation = null;
            genCaptcha();
        });

        /* ===== preview image ===== */
        receiptFile.addEventListener('change', () => {
            const f = receiptFile.files[0];
            if (!f) { previewImg.classList.add('hidden'); return; }
            if (!f.type.startsWith('image/')) { previewImg.classList.add('hidden'); return; }
            const r = new FileReader();
            r.onload = e => { previewImg.src = e.target.result; previewImg.classList.remove('hidden'); };
            r.readAsDataURL(f);
        });

        /* ===== cancel upload ===== */
        cancelUpload.addEventListener('click', () => {
            step2Box.classList.add('hidden');
            step1Form.classList.remove('hidden');
            step1Msg.classList.remove('hidden');
            step1Msg.textContent = 'Ù‚Ù…Øª Ø¨Ø¥Ù„ØºØ§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        });

        /* ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ + Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ===== */
        uploadBtn.addEventListener('click', async () => {
            uploadMsg.classList.add('hidden');

            const file = receiptFile.files[0];
            const depositNumber = depositNumberInput.value.trim();
            const payerName = payerNameInput.value.trim();
            if (!file) { uploadMsg.textContent = 'Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.'; uploadMsg.classList.remove('hidden'); return; }
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) { uploadMsg.textContent = 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… jpg Ø£Ùˆ png Ø£Ùˆ webp.'; uploadMsg.classList.remove('hidden'); return; }
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > MAX_RECEIPT_MB) { uploadMsg.textContent = 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙƒØ¨Ø± Ù…Ù† ' + MAX_RECEIPT_MB + ' Ù…ÙŠØ¬Ø§.'; uploadMsg.classList.remove('hidden'); return; }
            if (!depositNumber) { uploadMsg.textContent = 'Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„ØªØ­ÙˆÙŠÙ„.'; uploadMsg.classList.remove('hidden'); return; }
            if (!payerName) { uploadMsg.textContent = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„.'; uploadMsg.classList.remove('hidden'); return; }

            // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

            try {
                const orderId = sessionStorage.getItem('current_order_id');
                if (!orderId) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©).');

                let store = getStore();
                const idx = store.findIndex(s => s.id === orderId);
                if (idx === -1) throw new Error('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†.');

                // attach receipt to local store (as meta + base64 optional)
                const reader = await new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = rej;
                    r.readAsDataURL(file);
                });

                // Save receipt minimal info locally
                store[idx].receipt = { fileName: file.name, size: file.size, uploadedAt: Date.now(), depositNumber, payerName };
                saveStore(store);
                renderSubs(store[idx].phone);

                // Prepare Telegram message
                const order = store[idx];
                const textMsg = `
ğŸ“š Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${order.name}
ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${order.phone}
ğŸ“– Ø§Ù„ÙƒØªØ§Ø¨: ${order.bookTitle}
ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://www.google.com/maps/search/?api=1&query=${order.location.lat},${order.location.lon}
ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${order.notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
ğŸ’¸ Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹: ${depositNumber}
ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„: ${payerName}
ğŸ•’ ${new Date(order.time).toLocaleString('ar-EG')}
ID: ${order.id}
    `;

                // 1) Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                if (!BOT_TOKEN || !CHAT_ID) {
                    uploadMsg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† ØªÙˆÙƒÙ† Ø¨ÙˆØª/Ø´Ø§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…. Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¨ÙˆØª.';
                    uploadMsg.classList.remove('hidden');
                } else {
                    // send message
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: CHAT_ID, text: textMsg, parse_mode: 'Markdown' })
                    });

                    // 2) Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ€ photo (FormData)
                    const fd = new FormData();
                    fd.append('chat_id', CHAT_ID);
                    // append file blob directly
                    fd.append('photo', file, file.name);
                    // caption with small info
                    fd.append('caption', `Ø§ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ â€” ${order.name} â€” ${order.phone}`);

                    // Try to send photo
                    const photoResp = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                    if (!photoResp.ok) {
                        // Fallback: send photo as document or inform admin
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: CHAT_ID, text: `âš ï¸ ØªØ¹Ø°Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¹Ø¨Ø± API. Ø§ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ CORS.` })
                        });
                    }
                    uploadMsg.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙˆÙ Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§.';
                    uploadMsg.classList.remove('hidden');
                }

                // final UI
                previewImg.src = reader;
                previewImg.classList.remove('hidden');
                depositNumberInput.value = '';
                payerNameInput.value = '';
                receiptFile.value = '';
                sessionStorage.removeItem('current_order_id');

            } catch (err) {
                console.error(err);
                uploadMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (err.message || err);
                uploadMsg.classList.remove('hidden');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Ø±ÙØ¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
                renderSubs(); // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
            }
        });
    </script>
</body>

</html>